<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ›¼é¯Šé¯Šé–‹å­¸å­£åˆ®åˆ®æ¨‚</title>
  <style>
    /* ----- å…¨å±€èˆ‡æ’ç‰ˆ ----- */
    body { 
      text-align: center; 
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
      background: #f7f9fc; 
      margin: 0; 
      /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ‹‰å‹•é‡æ•´ */
      overscroll-behavior: none; 
    }
    
    h2 { color: #333; margin-top: 20px; }

    /* ----- è¼¸å…¥æ¡†å€åŸŸ (å¦‚æœæ²’å¸¶åƒæ•¸æ™‚é¡¯ç¤º) ----- */
    #inputSection {
      margin: 20px auto;
      padding: 15px;
      background: white;
      max-width: 90%;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
    }
    input { padding: 8px; font-size: 16px; width: 60%; border: 1px solid #ccc; border-radius: 4px; }
    #searchBtn { padding: 8px 16px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }

    /* ----- åˆ®åˆ®æ¨‚å€åŸŸ ----- */
    .wrapper { 
      position: relative; 
      width: 300px; 
      height: 150px; 
      margin: 20px auto; 
      user-select: none;
      -webkit-user-select: none;
      display: none; /* è³‡æ–™è¼‰å…¥å¾Œæ‰é¡¯ç¤º */
    }
    
    #prize {
      font-size: 24px; font-weight: bold; color: #333;
      text-align: center; line-height: 150px;
      position: absolute; width: 300px; height: 150px;
      background: white; border-radius: 12px;
      visibility: visible;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    #scratchCanvas {
      position: absolute; top: 0; left: 0;
      border-radius: 12px;
      transition: opacity 1s ease;
      cursor: crosshair;
      z-index: 2;
    }

    /* ----- æç¤ºå‹•ç•« ----- */
    #hint {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #333;
      font-weight: bold;
      text-shadow: 1px 1px 2px white;
      animation: pulse 1.2s infinite;
      pointer-events: none;
      user-select: none;
      z-index: 3;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.1); }
      100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    /* ----- æŒ‰éˆ•èˆ‡é€£çµ ----- */
    #actionArea { margin-top: 20px; min-height: 50px; }
    
    #rewardLink {
      display: none; /* åˆ®é–‹ä¸”æœ‰é€£çµæ™‚æ‰é¡¯ç¤º */
      margin-top: 15px; 
      font-size: 18px; 
      color: white;
      background-color: #00C300; /* LINE Green */
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 50px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #revealBtn {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      display: none; /* è³‡æ–™è¼‰å…¥å¾Œé¡¯ç¤º */
    }
    #revealBtn:hover { background: #45a049; }

    #statusMessage { font-size: 1.2em; color: #555; margin: 20px; font-weight: bold; }

    /* ----- åº•éƒ¨ç´€éŒ„åˆ—è¡¨ ----- */
    .log-container { margin-top: 40px; padding: 10px; background: #fff; border-top: 1px solid #eee; }
    table { width: 90%; max-width: 500px; margin: 10px auto; border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>

  <h2>ğŸ‰ æ›¼é¯Šé¯Šé–‹å­¸å­£åˆ®åˆ®æ¨‚ ğŸ‰</h2>

  <div id="statusMessage"></div>

  <div id="inputSection">
    <p>è«‹è¼¸å…¥æŠ½çåºè™Ÿï¼š</p>
    <input type="text" id="serialInput" placeholder="ä¾‹å¦‚: SHARK001">
    <button id="searchBtn" onclick="manualStart()">é–‹å§‹</button>
  </div>

  <div class="wrapper" id="scratchWrapper">
    <div id="prize">è¼‰å…¥ä¸­...</div>
    <canvas id="scratchCanvas" width="300" height="150"></canvas>
    <div id="hint">ğŸ‘‰ ç”¨æ‰‹æŒ‡æˆ–æ»‘é¼ åˆ®é–‹æˆ‘ï¼</div>
  </div>

  <div id="actionArea">
    <a id="rewardLink" href="#" target="_blank">ğŸ‘‰ é»æ­¤è‡³ LINE é ˜å–çå“!</a>
    <br>
    <button id="revealBtn">ç›´æ¥é¡¯ç¤ºçå“ ğŸ</button>
  </div>

  <div class="log-container">
    <h3>ğŸ† æœ€æ–°ä¸­çåå–®</h3>
    <p id="todayCount">ä»Šæ—¥æŠ½çäººæ•¸ï¼šè¼‰å…¥ä¸­...</p>
    <table id="logTable">
      <thead><tr><th>çå“</th><th>æ™‚é–“</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // âš ï¸âš ï¸ è«‹æ›¿æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€ âš ï¸âš ï¸
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHEwjdt1URWlRsDpuZFn-Mgqi62l_vSjtAa9up21d37UblgtnNPQgmW3SkDZTe_S2jtw/exec";
    
    // å…¨å±€è®Šæ•¸
    let prizeUrlData = ""; // å„²å­˜ API å›å‚³çš„é ˜çé€£çµ
    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");
    const prizeDiv = document.getElementById("prize");
    const rewardLink = document.getElementById("rewardLink");
    const revealBtn = document.getElementById("revealBtn");
    const hint = document.getElementById("hint");
    const wrapper = document.getElementById("scratchWrapper");
    const statusMsg = document.getElementById("statusMessage");

    // åˆå§‹åŒ–
    window.onload = function() {
        fetchLogs(); // è¼‰å…¥ç´€éŒ„

        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');

        if (code) {
            // è‡ªå‹•æ¨¡å¼
            statusMsg.innerText = "â³ æ­£åœ¨ç¢ºèªåºè™Ÿ...";
            startLottery(code);
        } else {
            // æ‰‹å‹•æ¨¡å¼
            document.getElementById("inputSection").style.display = "block";
            statusMsg.innerText = "";
        }
        
        // é å…ˆç¹ªè£½éŠ€æ¼† (é¿å…ç©ºç™½)
        resetCanvas();
    };

    function manualStart() {
        const inputCode = document.getElementById("serialInput").value.trim();
        if(!inputCode) return alert("è«‹è¼¸å…¥åºè™Ÿ");
        
        document.getElementById("inputSection").style.display = "none";
        statusMsg.innerText = "â³ æ­£åœ¨ç¢ºèªåºè™Ÿ...";
        startLottery(inputCode);
    }

    // --- API æ ¸å¿ƒé‚è¼¯ ---
    function startLottery(code) {
        fetch(`${GAS_API_URL}?code=${code}`)
            .then(res => res.json())
            .then(data => {
                statusMsg.innerText = ""; // æ¸…é™¤è¼‰å…¥æ–‡å­—
                
                if (data.status === "error") {
                    statusMsg.innerHTML = `<span style="color:red">âŒ ${data.message}</span>`;
                    document.getElementById("inputSection").style.display = "block"; // è®“ä½¿ç”¨è€…é‡æ–°è¼¸å…¥
                    return;
                }

                // è³‡æ–™ç²å–æˆåŠŸ
                setupScratchCard(data);
                
                // å†æ¬¡åˆ·æ–°ç´€éŒ„
                fetchLogs(); 
            })
            .catch(err => {
                console.error(err);
                statusMsg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                document.getElementById("inputSection").style.display = "block";
            });
    }

    // --- åˆ®åˆ®æ¨‚è¨­å®šé‚è¼¯ ---
    function setupScratchCard(data) {
        // 1. é¡¯ç¤ºåˆ®åˆ®æ¨‚å€åŸŸ
        wrapper.style.display = "block";
        revealBtn.style.display = "inline-block";

        // 2. å¡«å…¥çå“å…§å®¹
        prizeDiv.innerText = data.prizeName;
        prizeUrlData = data.prizeUrl || "";

        // 3. è™•ç†ã€Œå·²ä½¿ç”¨ã€çš„æƒ…æ³
        if (data.result === "played") {
             // é¸æ“‡ A: è®“ä½¿ç”¨è€…å†åˆ®ä¸€æ¬¡å›å‘³
             // é¸æ“‡ B: ç›´æ¥é¡¯ç¤º (é€™è£¡æˆ‘å€‘é¸ Aï¼Œä½†ä¿®æ”¹æç¤ºæ–‡å­—)
             statusMsg.innerHTML = "<small>âš ï¸ æ­¤åºè™Ÿå·²ä½¿ç”¨éï¼Œé€™æ˜¯ç•¶æ™‚çš„çµæœï¼š</small>";
        }

        // 4. é‡ç½®ç•«å¸ƒèˆ‡ç‹€æ…‹
        resetCanvas();
        canvas.style.opacity = "1";
        canvas.style.display = "block";
        hint.style.display = "block";
        
        // ç¶å®šåˆ®åˆ®æ¨‚äº‹ä»¶
        initScratchEvents();
    }

    // --- ç¹ªåœ–èˆ‡åˆ®é™¤é‚è¼¯ (ä¿ç•™ä½ åŸæœ¬çš„ Code) ---
    let isDrawing = false;
    let firstScratch = false;

    function resetCanvas() {
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "silver"; // éŠ€æ¼†é¡è‰²
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // å¯ä»¥åŠ ä¸€é»é›œè¨Šæˆ–æ–‡å­—è®“å®ƒçœ‹èµ·ä¾†æ›´åƒåˆ®åˆ®æ¨‚
        ctx.fillStyle = "#999";
        ctx.font = "20px Arial";
        ctx.fillText("æ›¼é¯Šé¯Š", 120, 80);
    }

    function scratch(e) {
        e.preventDefault();
        if (!isDrawing) return;

        if (!firstScratch) {
            hint.style.display = "none"; 
            firstScratch = true;
        }

        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        ctx.globalCompositeOperation = "destination-out";
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI * 2);
        ctx.fill();
        
        checkScratchPercent();
    }

    function revealPrize() {
        canvas.style.opacity = "0";
        hint.style.display = "none";
        
        setTimeout(() => {
            canvas.style.display = "none";
            prizeDiv.style.visibility = "visible";
            revealBtn.style.display = "none";

            // å¦‚æœæœ‰é ˜çé€£çµæ‰é¡¯ç¤º
            if (prizeUrlData) {
                rewardLink.href = prizeUrlData;
                rewardLink.style.display = "inline-block";
            }
        }, 800);
    }

    function checkScratchPercent() {
        // é™ä½é »ç‡ï¼šç°¡å–®åˆ¤æ–·ï¼Œå¦‚æœåˆ®äº†ä¸€å®šç¨‹åº¦å°±è‡ªå‹•é–‹ç
        // ç‚ºäº†æ•ˆèƒ½ï¼Œä¸è¦æ¯æ¬¡ move éƒ½è¨ˆç®—ï¼Œé€™è£¡ç¤ºç¯„ç°¡å–®ç‰ˆ
        // å¯¦éš›å„ªåŒ–å¯ç”¨è¨ˆæ•¸å™¨é™åˆ¶ getImageData å‘¼å«æ¬¡æ•¸
        if (Math.random() > 0.1) return; // åªæœ‰ 10% çš„æ©Ÿç‡æª¢æŸ¥ (å„ªåŒ–æ•ˆèƒ½)

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let cleared = 0;
        const len = imageData.data.length;
        for (let i = 3; i < len; i += 16) { // é–“éš”å–æ¨£åŠ é€Ÿ
            if (imageData.data[i] === 0) cleared++;
        }
        
        // é€™è£¡é™¤ä»¥ 4 æ˜¯å› ç‚ºé–“éš”å–æ¨£
        const totalPixels = (canvas.width * canvas.height) / 4; 
        const percent = (cleared / totalPixels) * 100;

        if (percent > 60 && canvas.style.opacity !== "0") { // é–€æª»è¨­ç‚º 60%
            revealPrize();
        }
    }

    function initScratchEvents() {
        // æ»‘é¼ 
        canvas.onmousedown = () => isDrawing = true;
        canvas.onmouseup = () => isDrawing = false;
        canvas.onmousemove = scratch;

        // è§¸æ§
        canvas.ontouchstart = (e) => { isDrawing = true; e.preventDefault(); };
        canvas.ontouchend = (e) => { isDrawing = false; e.preventDefault(); };
        canvas.ontouchmove = scratch;
        
        // æŒ‰éˆ•
        revealBtn.onclick = revealPrize;
    }

    // é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰åˆ·æ–°
    document.body.addEventListener("touchmove", function(e) {
        if (e.target.closest(".wrapper") || e.target === canvas) {
            e.preventDefault();
        }
    }, { passive: false });

    // --- æŠ“å–ç´€éŒ„ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
    function fetchLogs() {
        fetch(`${GAS_API_URL}?action=getLastResult`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById("todayCount").innerText = "ä»Šæ—¥æŠ½çäººæ•¸ï¼š" + data.todayCount;
                    const tbody = document.querySelector("#logTable tbody");
                    tbody.innerHTML = "";
                    data.logs.forEach(log => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td style="color:${log.color}">${log.prize}</td><td>${log.time.split(" ")[1]}</td>`;
                        tbody.appendChild(tr);
                    });
                }
            });
    }
  </script>
</body>
</html>
