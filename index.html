<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ›¼é¯Šé¯Šè–èª•åˆ®åˆ®æ¨‚</title>
  <style>
    /* ----- å…¨å±€èˆ‡æ’ç‰ˆ ----- */
    body { 
      text-align: center; 
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
      background: #FFF5EE; 
      margin: 0; 
      overscroll-behavior: none; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }
    
    h2 { 
      color: #c62828; 
      margin-bottom: 20px; 
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    /* ----- è¼¸å…¥æ¡†å€åŸŸ ----- */
    #inputSection {
      padding: 25px;
      background: white;
      width: 85%;
      max-width: 400px;
      border-radius: 15px;
      border: 2px solid #2e7d32; 
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
      display: none; 
    }
    input { 
      padding: 10px; font-size: 16px; width: 60%; 
      border: 1px solid #ccc; border-radius: 6px; 
      margin-right: 5px;
    }
    #searchBtn { 
      padding: 10px 20px; font-size: 16px; 
      background: #c62828; 
      color: white; 
      border: none; border-radius: 6px; cursor: pointer; 
      font-weight: bold;
    }
    #searchBtn:hover { background: #b71c1c; }

    /* ----- åˆ®åˆ®æ¨‚å€åŸŸ ----- */
    .wrapper { 
      position: relative; 
      width: 300px; 
      height: 150px; 
      margin: 20px auto; 
      user-select: none;
      -webkit-user-select: none;
      display: none; 
      border: 5px solid #c62828; 
      border-radius: 16px;
      box-shadow: 0 6px 15px rgba(198, 40, 40, 0.3);
    }
    
    #prize {
      font-size: 24px; font-weight: bold; color: #2e7d32; 
      text-align: center; line-height: 150px;
      position: absolute; width: 100%; height: 100%;
      background: white; 
      border-radius: 10px; 
      visibility: visible;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    #scratchCanvas {
      position: absolute; top: 0; left: 0;
      border-radius: 10px;
      cursor: crosshair;
      z-index: 2;
    }

    /* ----- æç¤ºå‹•ç•« ----- */
    #hint {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #fff; 
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
      animation: pulse 1.2s infinite;
      pointer-events: none;
      user-select: none;
      z-index: 3;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.1); }
      100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    /* ----- æŒ‰éˆ•èˆ‡é€£çµ ----- */
    #actionArea { margin-top: 25px; min-height: 60px; }
    
    #rewardLink {
      display: none; 
      margin-top: 15px; 
      font-size: 16px; 
      color: white;
      background-color: #2e7d32; 
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 50px;
      font-weight: bold;
      border: 2px solid #1b5e20;
      box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
      transition: transform 0.2s;
    }
    #rewardLink:active { transform: scale(0.95); }

    #revealBtn {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #fbc02d; 
      color: #333;
      font-weight: bold;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #revealBtn:hover { background: #f9a825; }

    #statusMessage { font-size: 1.1em; color: #555; margin: 15px; font-weight: bold; min-height: 24px;}
  </style>
</head>
<body>

  <h2>ğŸ„ æ›¼é¯Šé¯Šè–èª•åˆ®åˆ®æ¨‚ ğŸ…</h2>

  <div id="statusMessage"></div>

  <div id="inputSection">
    <div style="margin-bottom:10px; font-weight:bold; color:#2e7d32;">ğŸ è«‹è¼¸å…¥è–èª•åºè™Ÿï¼š</div>
    <input type="text" id="serialInput" placeholder="ä¾‹å¦‚: XMAS123">
    <button id="searchBtn" onclick="manualStart()">é ˜å–ç¦®ç‰©</button>
  </div>

  <div class="wrapper" id="scratchWrapper">
    <div id="prize">è¼‰å…¥ä¸­...</div>
    <canvas id="scratchCanvas" width="300" height="150"></canvas>
    <div id="hint">ğŸ‘‰ åˆ®é–‹é‡‘è‰²åœ–å±¤é ˜ç¦®ç‰©ï¼</div>
  </div>

  <div id="actionArea">
    <a id="rewardLink" href="#" target="_blank">ğŸ‘‰ é»æˆ‘å‰å¾€LINEé ˜å–é»æ•¸</a>
    <br>
    <button id="revealBtn">ç›´æ¥æ‰“é–‹ç¦®ç‰© ğŸ</button>
  </div>

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHEwjdt1URWlRsDpuZFn-Mgqi62l_vSjtAa9up21d37UblgtnNPQgmW3SkDZTe_S2jtw/exec";
    
    let prizeUrlData = ""; 
    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");
    const prizeDiv = document.getElementById("prize");
    const rewardLink = document.getElementById("rewardLink");
    const revealBtn = document.getElementById("revealBtn");
    const hint = document.getElementById("hint");
    const wrapper = document.getElementById("scratchWrapper");
    const statusMsg = document.getElementById("statusMessage");

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');

        if (code) {
            statusMsg.innerText = "ğŸ… è–èª•è€å…¬å…¬æ­£åœ¨æŸ¥è©¢...";
            startLottery(code);
        } else {
            document.getElementById("inputSection").style.display = "block";
            statusMsg.innerText = "";
        }
    };

    function manualStart() {
        const inputCode = document.getElementById("serialInput").value.trim();
        if(!inputCode) return alert("è«‹è¼¸å…¥åºè™Ÿ");
        
        document.getElementById("inputSection").style.display = "none";
        statusMsg.innerText = "ğŸ… è–èª•è€å…¬å…¬æ­£åœ¨æŸ¥è©¢...";
        startLottery(inputCode);
    }

    function startLottery(code) {
        fetch(`${GAS_API_URL}?code=${code}`)
            .then(res => res.json())
            .then(data => {
                statusMsg.innerText = ""; 
                
                if (data.status === "error") {
                    statusMsg.innerHTML = `<span style="color:#c62828">âŒ ${data.message}</span>`;
                    document.getElementById("inputSection").style.display = "block"; 
                    return;
                }

                setupScratchCard(data);
            })
            .catch(err => {
                console.error(err);
                statusMsg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                document.getElementById("inputSection").style.display = "block";
            });
    }

    // --- ä¿®æ”¹å¾Œçš„åˆ®åˆ®æ¨‚è¨­å®šé‚è¼¯ ---
    function setupScratchCard(data) {
        wrapper.style.display = "block";
        prizeDiv.innerText = data.prizeName;
        prizeUrlData = data.prizeUrl || "";

        if (data.result === "played") {
             // ğŸ æƒ…æ³ Aï¼šå·²ä½¿ç”¨é -> ç›´æ¥é¡¯ç¤ºçå“ (ä¸çµ¦åˆ®)
             statusMsg.innerHTML = "<small style='color:#f57f17'>âš ï¸ é€™å€‹ç¦®ç‰©å·²ç¶“é ˜éå›‰ï¼Œé€™æ˜¯ç•¶æ™‚çš„çµæœï¼š</small>";
             
             canvas.style.display = "none"; // éš±è—åˆ®åˆ®å¡—å±¤
             hint.style.display = "none";   // éš±è—æ‰‹æŒ‡æç¤º
             revealBtn.style.display = "none"; // éš±è—ã€Œç›´æ¥æ‰“é–‹ã€æŒ‰éˆ•

             // ç›´æ¥é¡¯ç¤ºé ˜çæŒ‰éˆ• (å¦‚æœæœ‰ç¶²å€)
             if (prizeUrlData) {
                rewardLink.href = prizeUrlData;
                rewardLink.style.display = "inline-block";
             }

        } else {
             // ğŸ†• æƒ…æ³ Bï¼šæ–°æŠ½ç -> æ­£å¸¸é¡¯ç¤ºåˆ®åˆ®æ¨‚
             revealBtn.style.display = "inline-block";
             resetCanvas(); // ç•«ä¸Šé‡‘è‰²å¡—å±¤
             canvas.style.opacity = "1";
             canvas.style.display = "block";
             hint.style.display = "block";
             initScratchEvents(); // ç¶å®šäº‹ä»¶
        }
    }

    // --- ç¹ªåœ–èˆ‡åˆ®é™¤é‚è¼¯ ---
    let isDrawing = false;
    let firstScratch = false;

    function resetCanvas() {
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "#FFD700"; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#B8860B"; 
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ğŸ„ Merry Christmas ğŸ„", canvas.width/2, canvas.height/2);
    }

    function scratch(e) {
        e.preventDefault();
        if (!isDrawing) return;

        if (!firstScratch) {
            hint.style.display = "none"; 
            firstScratch = true;
        }

        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        ctx.globalCompositeOperation = "destination-out";
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI * 2);
        ctx.fill();
        
        checkScratchPercent();
    }

    function revealPrize() {
        canvas.style.opacity = "0";
        hint.style.display = "none";
        
        setTimeout(() => {
            canvas.style.display = "none";
            prizeDiv.style.visibility = "visible";
            revealBtn.style.display = "none";

            if (prizeUrlData) {
                rewardLink.href = prizeUrlData;
                rewardLink.style.display = "inline-block";
            }
        }, 600);
    }

    function checkScratchPercent() {
        if (Math.random() > 0.1) return; 

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let cleared = 0;
        const len = imageData.data.length;
        for (let i = 3; i < len; i += 16) { 
            if (imageData.data[i] === 0) cleared++;
        }
        
        const totalPixels = (canvas.width * canvas.height) / 4; 
        const percent = (cleared / totalPixels) * 100;

        if (percent > 60 && canvas.style.opacity !== "0") { 
            revealPrize();
        }
    }

    function initScratchEvents() {
        canvas.onmousedown = () => isDrawing = true;
        canvas.onmouseup = () => isDrawing = false;
        canvas.onmousemove = scratch;

        canvas.ontouchstart = (e) => { isDrawing = true; e.preventDefault(); };
        canvas.ontouchend = (e) => { isDrawing = false; e.preventDefault(); };
        canvas.ontouchmove = scratch;
        
        revealBtn.onclick = revealPrize;
    }

    document.body.addEventListener("touchmove", function(e) {
        if (e.target.closest(".wrapper") || e.target === canvas) {
            e.preventDefault();
        }
    }, { passive: false });
  </script>
</body>
</html>
