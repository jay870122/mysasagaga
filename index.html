<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼é¯Šé¯Šåˆ®åˆ®æ¨‚</title>
    <style>
        body { text-align: center; font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f0f2f5;}
        .container { max-width: 600px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { padding: 10px; font-size: 16px; width: 60%; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #resultArea { margin-top: 20px; font-weight: bold; font-size: 1.2em; min-height: 50px;}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¦ˆ æ›¼é¯Šé¯Šåˆ®åˆ®æ¨‚ ğŸ¦ˆ</h1>
    
    <div id="inputSection">
        <input type="text" id="serialInput" placeholder="è«‹è¼¸å…¥åºè™Ÿ">
        <button id="drawBtn" onclick="manualClick()">é–‹å§‹åˆ®ç</button>
    </div>

    <div id="resultArea"></div>

    <hr>

    <h3>ğŸ‰ æœ€æ–°ä¸­çåå–®</h3>
    <p id="todayCount" style="font-size: 0.9em; color: #666;">ä»Šæ—¥æŠ½çäººæ•¸ï¼šè¼‰å…¥ä¸­...</p>
    <table id="logTable">
        <thead>
            <tr><th>çå“</th><th>æ™‚é–“</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // âš ï¸ è«‹æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHEwjdt1URWlRsDpuZFn-Mgqi62l_vSjtAa9up21d37UblgtnNPQgmW3SkDZTe_S2jtw/exec";

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    window.onload = function() {
        // 1. å…ˆè¼‰å…¥ä¸­çç´€éŒ„ (ä¸ç®¡æœ‰æ²’æœ‰åºè™Ÿéƒ½è¦é¡¯ç¤º)
        fetchLogs();

        // 2. åµæ¸¬ç¶²å€åƒæ•¸
        const params = new URLSearchParams(window.location.search);
        const codeFromUrl = params.get('code');

        if (codeFromUrl) {
            // å¦‚æœç¶²å€æœ‰åºè™Ÿï¼Œè‡ªå‹•å¡«å…¥ä¸¦åŸ·è¡Œ
            document.getElementById("serialInput").value = codeFromUrl;
            startLottery(codeFromUrl);
        }
    };

    // æ‰‹å‹•é»æ“ŠæŒ‰éˆ•æ™‚è§¸ç™¼
    function manualClick() {
        const code = document.getElementById("serialInput").value.trim();
        startLottery(code);
    }

    // æ ¸å¿ƒæŠ½çå‡½å¼
    function startLottery(code) {
        if (!code) {
            alert("è«‹è¼¸å…¥åºè™Ÿï¼");
            return;
        }

        // UI é–å®šï¼Œé¿å…é‡è¤‡é»æ“Š
        const btn = document.getElementById("drawBtn");
        const input = document.getElementById("serialInput");
        const resultArea = document.getElementById("resultArea");
        
        btn.disabled = true;
        input.disabled = true;
        resultArea.innerHTML = "â³ æ›¼é¯Šé¯Šæ­£åœ¨æŸ¥è©¢åºè™Ÿ...";

        // å‘¼å« GAS API
        fetch(`${GAS_API_URL}?code=${code}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "error") {
                    resultArea.innerHTML = `<span style="color:red">âŒ ${data.message}</span>`;
                    // éŒ¯èª¤æ™‚è§£é– UI è®“ä½¿ç”¨è€…é‡è©¦
                    btn.disabled = false;
                    input.disabled = false;
                } else {
                    // æˆåŠŸç²å¾—è³‡æ–™
                    // data.result å¯èƒ½æ˜¯ "new"(æ–°æŠ½) æˆ– "played"(å·²æŠ½é)
                    // data.prizeName æ˜¯çå“åç¨±
                    
                    // é€™è£¡ä½ å¯ä»¥æ±ºå®šè¦ç›´æ¥é¡¯ç¤ºæ–‡å­—ï¼Œé‚„æ˜¯å‘¼å«åˆ®åˆ®æ¨‚ Canvas
                    displayPrize(data);
                    
                    // åˆ·æ–°ç´€éŒ„
                    fetchLogs();
                }
            })
            .catch(err => {
                console.error(err);
                resultArea.innerHTML = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦";
                btn.disabled = false;
                input.disabled = false;
            });
    }

    // é¡¯ç¤ºçµæœ (é€™è£¡å¯ä»¥ä¹‹å¾Œæ”¹æˆä½ çš„åˆ®åˆ®æ¨‚ canvas é‚è¼¯)
    function displayPrize(data) {
        const resultArea = document.getElementById("resultArea");
        
        let html = "";
        if (data.result === "played") {
            html += "<p>âš ï¸ é€™å¼µåºè™Ÿå·²ç¶“ä½¿ç”¨éå›‰ï¼</p>";
        }
        
        html += `<h2 style="color: #d32f2f;">${data.prizeName}</h2>`;
        
        if (data.prizeUrl) {
            html += `<a href="${data.prizeUrl}" target="_blank" style="display:inline-block; padding:10px 20px; background:#28a745; color:white; text-decoration:none; border-radius:5px;">ğŸ é»æ­¤é ˜ç</a>`;
        }

        resultArea.innerHTML = html;
        
        // æˆåŠŸå¾Œé€šå¸¸ä¸è§£é–æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æŠ½åŒä¸€å€‹åºè™Ÿ
    }

    // æŠ“å–ç´€éŒ„å‡½å¼
    function fetchLogs() {
        fetch(`${GAS_API_URL}?action=getLastResult`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById("todayCount").innerText = "ä»Šæ—¥æŠ½çäººæ•¸ï¼š" + data.todayCount;
                    const tbody = document.querySelector("#logTable tbody");
                    tbody.innerHTML = "";
                    data.logs.forEach(log => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td style="color:${log.color}">${log.prize}</td><td>${log.time.split(" ")[1]}</td>`; // åªé¡¯ç¤ºæ™‚é–“éƒ¨åˆ†æ¯”è¼ƒç°¡æ½”
                        tbody.appendChild(tr);
                    });
                }
            });
    }
</script>

</body>
</html>
